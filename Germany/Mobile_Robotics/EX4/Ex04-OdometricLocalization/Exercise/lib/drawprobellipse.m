% h = drawprobellipse(x,C,alpha,color)%% Draws the ellipse of the x,y-components of the pose x = [x;y;theta]% on the significance level alpha. The 3x3 matrix C contains the asso-% ciated covariances (x, C can also be 2x1 or 2x2 respectively as the% third component gets ignored). The handle h is returned for graphic% styling. The function looks whether a function chi2inv exists (from% the Matlab statistics toolbox). Otherwise, a simple lookup table is% used. color is a [r g b]-vector or a Matlab color string (eg. 'r');% v.1.0, '97, 15.1.99, 9.11.02, koa% v.1.1, 11.11.02, koa: renamed from draw_prob_elli.m% v.1.2, 08.12.02, koa: x,C arguments replace x,y,sxx,syy,sxy% v.1.3, 05.01.03, koa: takes away imag. partfunction h = drawprobellipse(x,C,alpha,color);sxx = C(1,1); syy = C(2,2); sxy = C(1,2);a0 = sqrt(0.5*(sxx+syy+sqrt((sxx-syy)^2+4*sxy^2)));   % always greaterb0 = sqrt(0.5*(sxx+syy-sqrt((sxx-syy)^2+4*sxy^2)));   % always smallerif ~isreal(a0), a0 = real(a0); end;                   % in order to drawif ~isreal(b0), b0 = real(b0); end;                   % line-like ellipses% Scaling in order to reflect specified probabilityif exist('chi2inv') ~= 0,  a = a0*sqrt(chi2inv(alpha,2));  b = b0*sqrt(chi2inv(alpha,2));else  if     (alpha > 0.9999), thresh = 18.4207;  elseif (alpha < 0.9999) & (alpha >= 0.999), thresh = 13.8155;  elseif (alpha < 0.999 ) & (alpha >= 0.99 ), thresh = 9.2103;  elseif (alpha < 0.99  ) & (alpha >= 0.95 ), thresh = 5.9915;    elseif (alpha < 0.95  ) & (alpha >= 0.75 ), thresh = 2.7726;  elseif (alpha < 0.75  ) & (alpha >= 0.5  ), thresh = 1.3863;  end;  a = a0*sqrt(thresh);  b = b0*sqrt(thresh);end;% Look where the greater half axis belongs toif sxx < syy, swap = a; a = b; b = swap; end;% Calculate inclination numerically stableif sxx ~= syy,  angle = 0.5*atan(2*sxy/(sxx-syy));	elseif sxy == 0,  angle = 0;     % angle doesn't matter elseif sxy > 0,  angle =  pi/4;elseif sxy < 0,  angle = -pi/4;end;% Draw ellipseh = drawrotellipse(x(1),x(2),a,b,angle);set(h,'Color',color);